<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cài đặt - Tổ chức</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../../assets/css/style.css">
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="flex">
        <!-- Sidebar -->
        <div id="tochuc-sidebar"></div>

        <!-- Main Content -->
        <main class="flex-1 ml-64 p-6">
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Cài đặt</h1>
                <p class="text-gray-500">Quản lý thông tin và cài đặt tổ chức</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column - Thông tin tổ chức -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Thông tin cơ bản -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-4 border-b">
                            <h2 class="font-bold text-gray-800">Thông tin tổ chức</h2>
                        </div>
                        <form id="profileForm" class="p-4 space-y-4">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="relative">
                                    <img id="avatarPreview" src="../../assets/images/default-org.png" alt="Logo"
                                        class="w-20 h-20 rounded-full object-cover border-2 border-gray-200">
                                    <label
                                        class="absolute bottom-0 right-0 bg-blue-600 text-white p-1 rounded-full cursor-pointer hover:bg-blue-700">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        <input type="file" id="avatarInput" accept="image/*" class="hidden">
                                    </label>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800" id="orgNameDisplay">Tên tổ chức</p>
                                    <p class="text-sm text-gray-500" id="orgEmailDisplay">email@example.com</p>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tên tổ chức *</label>
                                    <input type="text" id="tenToChuc" required
                                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                    <input type="email" id="email" required
                                        class="w-full px-3 py-2 border rounded-lg bg-gray-100" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Số điện thoại</label>
                                    <input type="tel" id="soDienThoai"
                                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Website</label>
                                    <input type="url" id="website"
                                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                        placeholder="https://">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Địa chỉ</label>
                                <input type="text" id="diaChi"
                                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mô tả tổ chức</label>
                                <textarea id="moTa" rows="3"
                                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                    placeholder="Giới thiệu về tổ chức của bạn..."></textarea>
                            </div>
                            <div class="flex justify-end">
                                <button type="submit"
                                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Lưu thay đổi
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Đổi mật khẩu -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-4 border-b">
                            <h2 class="font-bold text-gray-800">Đổi mật khẩu</h2>
                        </div>
                        <form id="passwordForm" class="p-4 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu hiện tại *</label>
                                <input type="password" id="currentPassword" required
                                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu mới *</label>
                                <input type="password" id="newPassword" required minlength="6"
                                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-gray-400 mt-1">Tối thiểu 6 ký tự</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Xác nhận mật khẩu mới
                                    *</label>
                                <input type="password" id="confirmPassword" required
                                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="flex justify-end">
                                <button type="submit"
                                    class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    Đổi mật khẩu
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Right Column - Thống kê & Cài đặt khác -->
                <div class="space-y-6">
                    <!-- Thống kê tài khoản -->
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-bold text-gray-800 mb-4">Thống kê tài khoản</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Chiến dịch</span>
                                <span class="font-bold text-blue-600" id="statCampaigns">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Tình nguyện viên</span>
                                <span class="font-bold text-green-600" id="statVolunteers">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Người theo dõi</span>
                                <span class="font-bold text-purple-600" id="statFollowers">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Tổng quyên góp</span>
                                <span class="font-bold text-yellow-600" id="statDonations">0đ</span>
                            </div>
                        </div>
                    </div>

                    <!-- Trạng thái tài khoản -->
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-bold text-gray-800 mb-4">Trạng thái tài khoản</h3>
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                                <span class="text-gray-600">Đã xác thực</span>
                            </div>
                            <div class="text-sm text-gray-500">
                                <p>Ngày tham gia: <span id="joinDate">-</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Hỗ trợ -->
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-bold text-gray-800 mb-4">Hỗ trợ</h3>
                        <div class="space-y-3">
                            <a href="mailto:support@thiennguyen.vn"
                                class="flex items-center gap-2 text-blue-600 hover:underline text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                                support@thiennguyen.vn
                            </a>
                            <a href="tel:1900xxxx"
                                class="flex items-center gap-2 text-blue-600 hover:underline text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                </svg>
                                Hotline: 1900 xxxx
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>


    <script src="../../assets/js/config.js"></script>
    <script src="../../assets/js/tochuc-sidebar.js"></script>
    <script src="../../assets/js/unread-messages.js"></script>
    <script>
        if (!auth.isLoggedInAs('tochuc')) {
            window.location.href = '../login-tochuc.html';
        }

        let orgData = null;

        function logout() {
            auth.logoutAs('tochuc');
            window.location.href = '../login-tochuc.html';
        }

        function formatMoney(a) { return new Intl.NumberFormat('vi-VN').format(a || 0) + 'đ'; }
        function formatDate(d) { return d ? new Date(d).toLocaleDateString('vi-VN') : '-'; }

        // Load thông tin tổ chức
        async function loadOrgInfo() {
            const token = auth.getToken('tochuc');
            try {
                const res = await fetch(`${CONFIG.API_URL}/organization/thong-tin`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.success) {
                    orgData = data.data;
                    fillForm(orgData);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Load thống kê
        async function loadStats() {
            const token = auth.getToken('tochuc');
            try {
                const res = await fetch(`${CONFIG.API_URL}/organization/dashboard`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.success) {
                    const stats = data.data.thong_ke;
                    document.getElementById('statCampaigns').textContent = stats.tong_chien_dich || 0;
                    document.getElementById('statVolunteers').textContent = stats.tong_tinh_nguyen_vien || 0;
                    document.getElementById('statFollowers').textContent = stats.so_nguoi_theo_doi || 0;
                    document.getElementById('statDonations').textContent = formatMoney(stats.tong_quyen_gop);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Điền form với dữ liệu
        function fillForm(data) {
            document.getElementById('tenToChuc').value = data.ten_to_chuc || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('soDienThoai').value = data.so_dien_thoai || '';
            document.getElementById('website').value = data.website || '';
            document.getElementById('diaChi').value = data.dia_chi || '';
            document.getElementById('moTa').value = data.mo_ta || '';

            document.getElementById('orgNameDisplay').textContent = data.ten_to_chuc || 'Tổ chức';
            document.getElementById('orgEmailDisplay').textContent = data.email || '';
            document.getElementById('joinDate').textContent = formatDate(data.ngay_tao);

            if (data.logo) {
                document.getElementById('avatarPreview').src = `${CONFIG.API_URL.replace('/api', '')}${data.logo}`;
            }
        }

        // Preview avatar
        document.getElementById('avatarInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('avatarPreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Submit cập nhật thông tin
        document.getElementById('profileForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const token = auth.getToken('tochuc');

            const formData = new FormData();
            formData.append('ten_to_chuc', document.getElementById('tenToChuc').value);
            formData.append('so_dien_thoai', document.getElementById('soDienThoai').value);
            formData.append('website', document.getElementById('website').value);
            formData.append('dia_chi', document.getElementById('diaChi').value);
            formData.append('mo_ta', document.getElementById('moTa').value);

            const avatarFile = document.getElementById('avatarInput').files[0];
            if (avatarFile) {
                formData.append('logo', avatarFile);
            }

            try {
                const res = await fetch(`${CONFIG.API_URL}/organization/cap-nhat`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const data = await res.json();
                if (data.success) {
                    alert('Cập nhật thông tin thành công!');
                    loadOrgInfo();
                } else {
                    alert(data.message || 'Có lỗi xảy ra');
                }
            } catch (error) {
                alert('Lỗi kết nối server');
            }
        });

        // Submit đổi mật khẩu
        document.getElementById('passwordForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;

            if (newPass !== confirmPass) {
                alert('Mật khẩu xác nhận không khớp!');
                return;
            }

            const token = auth.getToken('tochuc');
            try {
                const res = await fetch(`${CONFIG.API_URL}/organization/doi-mat-khau`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        mat_khau_cu: document.getElementById('currentPassword').value,
                        mat_khau_moi: newPass
                    })
                });
                const data = await res.json();
                if (data.success) {
                    alert('Đổi mật khẩu thành công!');
                    document.getElementById('passwordForm').reset();
                } else {
                    alert(data.message || 'Có lỗi xảy ra');
                }
            } catch (error) {
                alert('Lỗi kết nối server');
            }
        });

        // Init
        loadOrgInfo();
        loadStats();
    </script>
</body>

</html>