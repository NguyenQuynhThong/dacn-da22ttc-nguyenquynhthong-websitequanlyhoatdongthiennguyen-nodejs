<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω b√¨nh lu·∫≠n - T·ªï ch·ª©c</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../../assets/css/style.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="flex">
        <!-- Sidebar -->
        <div id="tochuc-sidebar"></div>

        <!-- Main Content -->
        <main class="flex-1 ml-64 p-6">
            <div class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Qu·∫£n l√Ω b√¨nh lu·∫≠n</h1>
                    <p class="text-gray-600">Xem v√† ph·∫£n h·ªìi b√¨nh lu·∫≠n tr√™n c√°c chi·∫øn d·ªãch c·ªßa b·∫°n</p>
                </div>
                <select id="filterCampaign" onchange="loadComments()" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">T·∫•t c·∫£ chi·∫øn d·ªãch</option>
                </select>
            </div>

            <!-- Comments List -->
            <div id="commentsList" class="space-y-4">
                <div class="bg-white rounded-lg shadow p-6 text-center text-gray-500">
                    ƒêang t·∫£i b√¨nh lu·∫≠n...
                </div>
            </div>
        </main>
    </div>

    <!-- Reply Modal -->
    <div id="replyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Ph·∫£n h·ªìi b√¨nh lu·∫≠n</h3>
                <button onclick="closeReplyModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <div id="originalComment" class="bg-gray-50 p-3 rounded-lg mb-4 text-sm text-gray-600"></div>
            <form id="replyForm">
                <input type="hidden" id="replyCommentId">
                <textarea id="replyContent" rows="3" required
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                    placeholder="Nh·∫≠p n·ªôi dung ph·∫£n h·ªìi..."></textarea>
                <button type="submit" class="mt-4 w-full gradient-primary text-white py-2 rounded-lg font-semibold">
                    G·ª≠i ph·∫£n h·ªìi
                </button>
            </form>
        </div>
    </div>

    <script src="../../assets/js/config.js"></script>
    <script src="../../assets/js/tochuc-sidebar.js"></script>
    <script>
        // Check auth
        if (!auth.isLoggedInAs('tochuc')) {
            window.location.href = '../login-tochuc.html';
        }

        function logout() {
            auth.logoutAs('tochuc');
            window.location.href = '../login-tochuc.html';
        }

        // Load campaigns for filter
        async function loadCampaigns() {
            try {
                const token = auth.getToken('tochuc');
                const res = await fetch(`${CONFIG.API_URL}/organization/chien-dich`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (data.success) {
                    const select = document.getElementById('filterCampaign');
                    data.data.forEach(c => {
                        select.innerHTML += `<option value="${c.chien_dich_id}">${c.ten_chien_dich}</option>`;
                    });
                }
            } catch (e) {
                console.error('L·ªói load chi·∫øn d·ªãch:', e);
            }
        }

        // Load comments
        async function loadComments() {
            const token = auth.getToken('tochuc');
            const campaignId = document.getElementById('filterCampaign').value;
            
            try {
                let url = `${CONFIG.API_URL}/organization/binh-luan`;
                if (campaignId) url += `?chien_dich_id=${campaignId}`;

                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (data.success) {
                    renderComments(data.data);
                }
            } catch (e) {
                console.error('L·ªói load b√¨nh lu·∫≠n:', e);
            }
        }

        function renderComments(comments) {
            const container = document.getElementById('commentsList');
            
            if (comments.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-6 text-center text-gray-500">
                        <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                        <p>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = comments.map(c => {
                const isOrgComment = c.to_chuc_id !== null;
                const name = isOrgComment ? c.org_name : c.user_name;
                const avatar = isOrgComment ? c.org_logo : c.user_avatar;
                const initial = name ? name.charAt(0).toUpperCase() : '?';
                const isReply = c.parent_id !== null;

                return `
                    <div class="bg-white rounded-lg shadow p-4 ${isReply ? 'ml-8 border-l-4 border-blue-200' : ''}">
                        <div class="flex gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0 ${isOrgComment ? 'bg-green-500' : 'bg-blue-500'}">
                                ${avatar ? `<img src="${avatar}" class="w-10 h-10 rounded-full object-cover">` : initial}
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-semibold text-gray-800">${name || '·∫®n danh'}</span>
                                    ${isOrgComment ? '<span class="text-xs bg-green-100 text-green-600 px-2 py-0.5 rounded">T·ªï ch·ª©c</span>' : ''}
                                    <span class="text-xs text-gray-400">${timeAgo(c.ngay_binh_luan)}</span>
                                </div>
                                <p class="text-gray-700 mb-2">${c.noi_dung}</p>
                                <div class="flex items-center gap-4 text-sm">
                                    <span class="text-gray-500">üìç ${c.ten_chien_dich}</span>
                                    ${!isOrgComment && !isReply ? `
                                        <button onclick="openReplyModal(${c.binh_luan_id}, '${escapeHtml(c.noi_dung)}', '${name}')" 
                                            class="text-blue-600 hover:underline">Ph·∫£n h·ªìi</button>
                                    ` : ''}
                                    <button onclick="deleteComment(${c.binh_luan_id})" class="text-red-600 hover:underline">X√≥a</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        function timeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            if (seconds < 60) return 'V·ª´a xong';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' ph√∫t tr∆∞·ªõc';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' gi·ªù tr∆∞·ªõc';
            return Math.floor(seconds / 86400) + ' ng√†y tr∆∞·ªõc';
        }

        // Reply modal
        function openReplyModal(commentId, content, userName) {
            document.getElementById('replyCommentId').value = commentId;
            document.getElementById('originalComment').innerHTML = `<strong>${userName}:</strong> ${content}`;
            document.getElementById('replyContent').value = '';
            document.getElementById('replyModal').classList.remove('hidden');
        }

        function closeReplyModal() {
            document.getElementById('replyModal').classList.add('hidden');
        }

        document.getElementById('replyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const commentId = document.getElementById('replyCommentId').value;
            const content = document.getElementById('replyContent').value;
            const token = auth.getToken('tochuc');

            try {
                const res = await fetch(`${CONFIG.API_URL}/organization/binh-luan/${commentId}/reply`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ noi_dung: content })
                });
                const data = await res.json();

                if (data.success) {
                    alert('Ph·∫£n h·ªìi th√†nh c√¥ng!');
                    closeReplyModal();
                    loadComments();
                } else {
                    alert(data.message || 'C√≥ l·ªói x·∫£y ra');
                }
            } catch (e) {
                alert('L·ªói k·∫øt n·ªëi server');
            }
        });

        async function deleteComment(commentId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√¨nh lu·∫≠n n√†y?')) return;

            const token = auth.getToken('tochuc');
            try {
                const res = await fetch(`${CONFIG.API_URL}/organization/binh-luan/${commentId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (data.success) {
                    loadComments();
                } else {
                    alert(data.message || 'C√≥ l·ªói x·∫£y ra');
                }
            } catch (e) {
                alert('L·ªói k·∫øt n·ªëi server');
            }
        }

        // Init
        loadCampaigns();
        loadComments();
    </script>
</body>
</html>
