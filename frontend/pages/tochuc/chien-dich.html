<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Chiến dịch - Tổ chức</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../../assets/css/style.css">
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="flex">
        <!-- Sidebar -->
        <div id="tochuc-sidebar"></div>

        <!-- Main Content -->
        <main class="flex-1 ml-64 p-6">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Quản lý Chiến dịch</h1>
                    <p class="text-gray-500">Tạo và quản lý các chiến dịch thiện nguyện</p>
                </div>
                <button onclick="openCreateModal()"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Tạo chiến dịch mới
                </button>
            </div>

            <!-- Filter Tabs -->
            <div class="bg-white rounded-lg shadow mb-6">
                <div class="flex border-b">
                    <button onclick="filterCampaigns('all')"
                        class="filter-tab px-6 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600"
                        data-filter="all">
                        Tất cả
                    </button>
                    <button onclick="filterCampaigns('dang_dien_ra')"
                        class="filter-tab px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700"
                        data-filter="dang_dien_ra">
                        Đang diễn ra
                    </button>
                    <button onclick="filterCampaigns('tam_dung')"
                        class="filter-tab px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700"
                        data-filter="tam_dung">
                        Tạm dừng
                    </button>
                    <button onclick="filterCampaigns('cho_duyet')"
                        class="filter-tab px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700"
                        data-filter="cho_duyet">
                        Chờ duyệt
                    </button>
                    <button onclick="filterCampaigns('da_ket_thuc')"
                        class="filter-tab px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700"
                        data-filter="da_ket_thuc">
                        Đã kết thúc
                    </button>
                </div>
            </div>

            <!-- Campaign List -->
            <div id="campaignList" class="space-y-4">
                <div class="bg-white rounded-lg shadow p-6 text-center text-gray-500">
                    Đang tải...
                </div>
            </div>
        </main>
    </div>


    <!-- Modal Tạo/Sửa Chiến dịch -->
    <div id="campaignModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 my-8">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-bold text-gray-800" id="modalTitle">Tạo chiến dịch mới</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form id="campaignForm" class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                <input type="hidden" id="campaignId">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tên chiến dịch *</label>
                    <input type="text" id="tenChienDich" required
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="VD: Hỗ trợ trẻ em vùng cao">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mô tả ngắn *</label>
                    <textarea id="moTa" rows="2" required
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="Mô tả ngắn gọn về chiến dịch"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nội dung chi tiết</label>
                    <textarea id="noiDungChiTiet" rows="4"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="Mô tả chi tiết về mục đích, đối tượng hưởng lợi..."></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mục tiêu quyên góp (VNĐ)</label>
                        <input type="number" id="mucTieuTien" min="0" step="100000"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                            placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Số TNV cần</label>
                        <input type="number" id="mucTieuTNV" min="0"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                            placeholder="0">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ngày bắt đầu *</label>
                        <input type="date" id="ngayBatDau" required
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ngày kết thúc *</label>
                        <input type="date" id="ngayKetThuc" required
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Địa điểm</label>
                    <input type="text" id="diaDiem"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="VD: Hà Giang, Việt Nam">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mục tiêu hiện vật</label>
                    <input type="text" id="mucTieuHienVat"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="VD: 100 áo ấm, 50 chăn bông">
                </div>

                <div class="flex gap-3 pt-4 border-t">
                    <button type="button" onclick="closeModal()"
                        class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Hủy
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Lưu chiến dịch
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Xem chi tiết -->
    <div id="detailModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl mx-4 my-8">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-bold text-gray-800">Chi tiết chiến dịch</h3>
                <button onclick="closeDetailModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="detailContent" class="p-6 max-h-[70vh] overflow-y-auto">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Modal Thay đổi trạng thái -->
    <div id="statusModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-bold text-gray-800" id="statusModalTitle">Thay đổi trạng thái</h3>
                <button onclick="closeStatusModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <p class="text-gray-600 mb-2">Chiến dịch:</p>
                    <p class="font-semibold text-gray-800" id="statusModalCampaignName"></p>
                </div>
                <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-sm text-yellow-700" id="statusModalDescription"></p>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Lý do (không bắt buộc)</label>
                    <textarea id="statusReason" rows="3"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="Nhập lý do thay đổi trạng thái..."></textarea>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeStatusModal()" class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Hủy
                    </button>
                    <button onclick="confirmStatusChange()" id="statusConfirmBtn"
                        class="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                        Xác nhận
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="../../assets/js/config.js"></script>
    <script src="../../assets/js/tochuc-sidebar.js"></script>
    <script src="../../assets/js/unread-messages.js"></script>
    <script>
        // Check auth
        if (!auth.isLoggedInAs('tochuc')) {
            window.location.href = '../login-tochuc.html';
        }

        let allCampaigns = [];
        let currentFilter = 'all';

        function logout() {
            auth.logoutAs('tochuc');
            window.location.href = '../login-tochuc.html';
        }

        function formatMoney(a) { return new Intl.NumberFormat('vi-VN').format(a) + 'đ'; }
        function formatDate(d) { return d ? new Date(d).toLocaleDateString('vi-VN') : '-'; }

        function getStatusBadge(status) {
            const badges = {
                'cho_duyet': '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs">Chờ duyệt</span>',
                'dang_dien_ra': '<span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs">Đang diễn ra</span>',
                'da_ket_thuc': '<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded-full text-xs">Đã kết thúc</span>',
                'ket_thuc': '<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded-full text-xs">Đã kết thúc</span>',
                'tu_choi': '<span class="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs">Bị từ chối</span>',
                'tam_dung': '<span class="px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-xs">Tạm dừng</span>'
            };
            return badges[status] || status;
        }

        // Hiển thị nút hành động trạng thái dựa vào trạng thái hiện tại
        function getStatusActions(campaign) {
            const status = campaign.trang_thai;
            let actions = '';

            if (status === 'dang_dien_ra') {
                actions = `
                    <button onclick="openStatusModal(${campaign.chien_dich_id}, 'tam_dung')" 
                        class="p-2 text-orange-500 hover:bg-orange-50 rounded" title="Tạm dừng">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                    <button onclick="openStatusModal(${campaign.chien_dich_id}, 'ket_thuc')" 
                        class="p-2 text-red-500 hover:bg-red-50 rounded" title="Kết thúc sớm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                        </svg>
                    </button>
                `;
            } else if (status === 'tam_dung') {
                actions = `
                    <button onclick="resumeCampaign(${campaign.chien_dich_id})" 
                        class="p-2 text-green-500 hover:bg-green-50 rounded" title="Tiếp tục chiến dịch">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                    <button onclick="openStatusModal(${campaign.chien_dich_id}, 'ket_thuc')" 
                        class="p-2 text-red-500 hover:bg-red-50 rounded" title="Kết thúc sớm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                        </svg>
                    </button>
                `;
            } else if (status === 'ket_thuc' || status === 'da_ket_thuc') {
                actions = `
                    <button onclick="reopenCampaign(${campaign.chien_dich_id})" 
                        class="p-2 text-blue-500 hover:bg-blue-50 rounded" title="Mở lại chiến dịch">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                `;
            }
            return actions;
        }

        // Load campaigns
        async function loadCampaigns() {
            const token = auth.getToken('tochuc');
            console.log('Loading campaigns with token:', token ? 'có token' : 'không có token');

            if (!token) {
                document.getElementById('campaignList').innerHTML =
                    '<div class="bg-white rounded-lg shadow p-6 text-center text-red-500">Chưa đăng nhập. Vui lòng đăng nhập lại.</div>';
                return;
            }

            try {
                const res = await fetch(`${CONFIG.API_URL}/organization/chien-dich`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                console.log('API response:', data);

                if (data.success) {
                    allCampaigns = data.data;
                    renderCampaigns();
                } else {
                    document.getElementById('campaignList').innerHTML =
                        `<div class="bg-white rounded-lg shadow p-6 text-center text-red-500">Lỗi: ${data.message}</div>`;
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('campaignList').innerHTML =
                    '<div class="bg-white rounded-lg shadow p-6 text-center text-red-500">Lỗi kết nối server</div>';
            }
        }

        function filterCampaigns(filter) {
            currentFilter = filter;
            // Update tabs UI
            document.querySelectorAll('.filter-tab').forEach(tab => {
                if (tab.dataset.filter === filter) {
                    tab.classList.add('border-b-2', 'border-blue-500', 'text-blue-600');
                    tab.classList.remove('text-gray-500');
                } else {
                    tab.classList.remove('border-b-2', 'border-blue-500', 'text-blue-600');
                    tab.classList.add('text-gray-500');
                }
            });
            renderCampaigns();
        }

        function renderCampaigns() {
            let filtered = allCampaigns;
            if (currentFilter !== 'all') {
                // Hỗ trợ cả 'ket_thuc' và 'da_ket_thuc' cho filter đã kết thúc
                if (currentFilter === 'da_ket_thuc') {
                    filtered = allCampaigns.filter(c => c.trang_thai === 'da_ket_thuc' || c.trang_thai === 'ket_thuc');
                } else {
                    filtered = allCampaigns.filter(c => c.trang_thai === currentFilter);
                }
            }

            if (filtered.length === 0) {
                document.getElementById('campaignList').innerHTML =
                    '<div class="bg-white rounded-lg shadow p-6 text-center text-gray-500">Không có chiến dịch nào</div>';
                return;
            }

            document.getElementById('campaignList').innerHTML = filtered.map(c => {
                const progress = c.muc_tieu_tien > 0 ? (c.so_tien_da_quyen_gop / c.muc_tieu_tien * 100).toFixed(1) : 0;
                const tnvProgress = c.muc_tieu_tinh_nguyen_vien > 0 ?
                    (c.so_tinh_nguyen_vien_hien_tai / c.muc_tieu_tinh_nguyen_vien * 100).toFixed(1) : 0;

                return `
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="text-lg font-bold text-gray-800">${c.ten_chien_dich}</h3>
                                    ${getStatusBadge(c.trang_thai)}
                                </div>
                                <p class="text-gray-600 text-sm line-clamp-2">${c.mo_ta || ''}</p>
                            </div>
                            <div class="flex gap-1 ml-4">
                                <button onclick="viewDetail(${c.chien_dich_id})" class="p-2 text-gray-500 hover:bg-gray-100 rounded" title="Xem chi tiết">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                </button>
                                <button onclick="editCampaign(${c.chien_dich_id})" class="p-2 text-blue-500 hover:bg-blue-50 rounded" title="Sửa">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                                ${getStatusActions(c)}
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div class="text-center p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-500">Quyên góp</p>
                                <p class="font-bold text-green-600">${formatMoney(c.so_tien_da_quyen_gop)}</p>
                                <p class="text-xs text-gray-400">/ ${formatMoney(c.muc_tieu_tien)}</p>
                            </div>
                            <div class="text-center p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-500">Tình nguyện viên</p>
                                <p class="font-bold text-purple-600">${c.so_tinh_nguyen_vien_hien_tai || 0}</p>
                                <p class="text-xs text-gray-400">/ ${c.muc_tieu_tinh_nguyen_vien || 0}</p>
                            </div>
                            <div class="text-center p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-500">Bắt đầu</p>
                                <p class="font-medium text-gray-700">${formatDate(c.ngay_bat_dau)}</p>
                            </div>
                            <div class="text-center p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-500">Kết thúc</p>
                                <p class="font-medium text-gray-700">${formatDate(c.ngay_ket_thuc)}</p>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <div>
                                <div class="flex justify-between text-xs text-gray-500 mb-1">
                                    <span>Tiến độ quyên góp</span>
                                    <span>${progress}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full transition-all" style="width: ${Math.min(progress, 100)}%"></div>
                                </div>
                            </div>
                            ${c.muc_tieu_tinh_nguyen_vien > 0 ? `
                            <div>
                                <div class="flex justify-between text-xs text-gray-500 mb-1">
                                    <span>Tình nguyện viên</span>
                                    <span>${tnvProgress}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-purple-500 h-2 rounded-full transition-all" style="width: ${Math.min(tnvProgress, 100)}%"></div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Modal functions
        function openCreateModal() {
            document.getElementById('modalTitle').textContent = 'Tạo chiến dịch mới';
            document.getElementById('campaignForm').reset();
            document.getElementById('campaignId').value = '';
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('ngayBatDau').value = today;
            document.getElementById('campaignModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('campaignModal').classList.add('hidden');
        }

        function editCampaign(id) {
            const campaign = allCampaigns.find(c => c.chien_dich_id === id);
            if (!campaign) return;

            document.getElementById('modalTitle').textContent = 'Sửa chiến dịch';
            document.getElementById('campaignId').value = id;
            document.getElementById('tenChienDich').value = campaign.ten_chien_dich || '';
            document.getElementById('moTa').value = campaign.mo_ta || '';
            document.getElementById('noiDungChiTiet').value = campaign.noi_dung_chi_tiet || '';
            document.getElementById('mucTieuTien').value = campaign.muc_tieu_tien || 0;
            document.getElementById('mucTieuTNV').value = campaign.muc_tieu_tinh_nguyen_vien || 0;
            document.getElementById('ngayBatDau').value = campaign.ngay_bat_dau ? campaign.ngay_bat_dau.split('T')[0] : '';
            document.getElementById('ngayKetThuc').value = campaign.ngay_ket_thuc ? campaign.ngay_ket_thuc.split('T')[0] : '';
            document.getElementById('diaDiem').value = campaign.dia_diem || '';
            document.getElementById('mucTieuHienVat').value = campaign.muc_tieu_hien_vat || '';

            document.getElementById('campaignModal').classList.remove('hidden');
        }

        // Form submit
        document.getElementById('campaignForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const token = auth.getToken('tochuc');
            const campaignId = document.getElementById('campaignId').value;
            const isEdit = !!campaignId;

            const payload = {
                ten_chien_dich: document.getElementById('tenChienDich').value,
                mo_ta: document.getElementById('moTa').value,
                noi_dung_chi_tiet: document.getElementById('noiDungChiTiet').value,
                muc_tieu_tien: parseInt(document.getElementById('mucTieuTien').value) || 0,
                muc_tieu_tinh_nguyen_vien: parseInt(document.getElementById('mucTieuTNV').value) || 0,
                ngay_bat_dau: document.getElementById('ngayBatDau').value,
                ngay_ket_thuc: document.getElementById('ngayKetThuc').value,
                dia_diem: document.getElementById('diaDiem').value,
                muc_tieu_hien_vat: document.getElementById('mucTieuHienVat').value
            };

            try {
                const url = isEdit
                    ? `${CONFIG.API_URL}/organization/chien-dich/${campaignId}`
                    : `${CONFIG.API_URL}/organization/chien-dich`;

                const res = await fetch(url, {
                    method: isEdit ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (data.success) {
                    alert(isEdit ? 'Cập nhật thành công!' : 'Tạo chiến dịch thành công! Đang chờ Admin phê duyệt.');
                    closeModal();
                    loadCampaigns();
                } else {
                    alert(data.message || 'Có lỗi xảy ra');
                }
            } catch (error) {
                alert('Lỗi kết nối server');
            }
        });

        // View detail
        function viewDetail(id) {
            const c = allCampaigns.find(c => c.chien_dich_id === id);
            if (!c) return;

            const progress = c.muc_tieu_tien > 0 ? (c.so_tien_da_quyen_gop / c.muc_tieu_tien * 100).toFixed(1) : 0;

            document.getElementById('detailContent').innerHTML = `
                <div class="space-y-6">
                    <div>
                        <div class="flex items-center gap-3 mb-2">
                            <h2 class="text-2xl font-bold text-gray-800">${c.ten_chien_dich}</h2>
                            ${getStatusBadge(c.trang_thai)}
                        </div>
                        <p class="text-gray-600">${c.mo_ta || ''}</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-green-50 rounded-lg">
                            <p class="text-sm text-green-600">Đã quyên góp</p>
                            <p class="text-2xl font-bold text-green-700">${formatMoney(c.so_tien_da_quyen_gop)}</p>
                            <p class="text-sm text-green-600">Mục tiêu: ${formatMoney(c.muc_tieu_tien)}</p>
                            <div class="w-full bg-green-200 rounded-full h-2 mt-2">
                                <div class="bg-green-500 h-2 rounded-full" style="width: ${Math.min(progress, 100)}%"></div>
                            </div>
                        </div>
                        <div class="p-4 bg-purple-50 rounded-lg">
                            <p class="text-sm text-purple-600">Tình nguyện viên</p>
                            <p class="text-2xl font-bold text-purple-700">${c.so_tinh_nguyen_vien_hien_tai || 0}</p>
                            <p class="text-sm text-purple-600">Mục tiêu: ${c.muc_tieu_tinh_nguyen_vien || 0}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="text-gray-500">Ngày bắt đầu</p>
                            <p class="font-medium">${formatDate(c.ngay_bat_dau)}</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Ngày kết thúc</p>
                            <p class="font-medium">${formatDate(c.ngay_ket_thuc)}</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Địa điểm</p>
                            <p class="font-medium">${c.dia_diem || '-'}</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Ngày tạo</p>
                            <p class="font-medium">${formatDate(c.ngay_tao)}</p>
                        </div>
                    </div>

                    ${c.noi_dung_chi_tiet ? `
                    <div>
                        <p class="text-gray-500 mb-2">Nội dung chi tiết</p>
                        <div class="p-4 bg-gray-50 rounded-lg text-gray-700 whitespace-pre-wrap">${c.noi_dung_chi_tiet}</div>
                    </div>
                    ` : ''}

                    <div class="flex gap-3 pt-4 border-t">
                        <button onclick="closeDetailModal()" class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">
                            Đóng
                        </button>
                        <button onclick="closeDetailModal(); editCampaign(${c.chien_dich_id})" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Chỉnh sửa
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('detailModal').classList.remove('hidden');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        // === QUẢN LÝ TRẠNG THÁI CHIẾN DỊCH ===
        let currentStatusCampaignId = null;
        let currentNewStatus = null;

        function openStatusModal(campaignId, newStatus) {
            currentStatusCampaignId = campaignId;
            currentNewStatus = newStatus;

            const campaign = allCampaigns.find(c => c.chien_dich_id === campaignId);
            if (!campaign) return;

            const statusLabels = {
                'tam_dung': 'Tạm dừng chiến dịch',
                'ket_thuc': 'Kết thúc sớm chiến dịch',
                'da_ket_thuc': 'Kết thúc sớm chiến dịch'
            };

            const statusDescriptions = {
                'tam_dung': 'Chiến dịch sẽ tạm ngừng hoạt động. Bạn có thể tiếp tục sau.',
                'ket_thuc': 'Chiến dịch sẽ kết thúc và không thể tiếp tục. Hành động này không thể hoàn tác.',
                'da_ket_thuc': 'Chiến dịch sẽ kết thúc và không thể tiếp tục. Hành động này không thể hoàn tác.'
            };

            document.getElementById('statusModalTitle').textContent = statusLabels[newStatus];
            document.getElementById('statusModalCampaignName').textContent = campaign.ten_chien_dich;
            document.getElementById('statusModalDescription').textContent = statusDescriptions[newStatus];
            document.getElementById('statusReason').value = '';

            // Đổi màu nút xác nhận
            const confirmBtn = document.getElementById('statusConfirmBtn');
            if (newStatus === 'ket_thuc' || newStatus === 'da_ket_thuc') {
                confirmBtn.className = 'flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700';
                confirmBtn.textContent = 'Kết thúc chiến dịch';
            } else {
                confirmBtn.className = 'flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700';
                confirmBtn.textContent = 'Tạm dừng chiến dịch';
            }

            document.getElementById('statusModal').classList.remove('hidden');
        }

        function closeStatusModal() {
            document.getElementById('statusModal').classList.add('hidden');
            currentStatusCampaignId = null;
            currentNewStatus = null;
        }

        async function confirmStatusChange() {
            if (!currentStatusCampaignId || !currentNewStatus) return;

            const token = auth.getToken('tochuc');
            const lyDo = document.getElementById('statusReason').value.trim();

            try {
                const res = await fetch(`${CONFIG.API_URL}/organization/chien-dich/${currentStatusCampaignId}/trang-thai`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        trang_thai: currentNewStatus,
                        ly_do: lyDo
                    })
                });

                const data = await res.json();
                if (data.success) {
                    alert(data.message);
                    closeStatusModal();
                    loadCampaigns();
                } else {
                    alert(data.message || 'Có lỗi xảy ra');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Lỗi kết nối server');
            }
        }

        async function resumeCampaign(campaignId) {
            if (!confirm('Bạn có chắc muốn tiếp tục chiến dịch này?')) return;

            const token = auth.getToken('tochuc');

            try {
                const res = await fetch(`${CONFIG.API_URL}/organization/chien-dich/${campaignId}/tiep-tuc`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await res.json();
                if (data.success) {
                    alert(data.message);
                    loadCampaigns();
                } else {
                    alert(data.message || 'Có lỗi xảy ra');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Lỗi kết nối server');
            }
        }

        async function reopenCampaign(campaignId) {
            if (!confirm('Bạn có chắc muốn mở lại chiến dịch này?\nChiến dịch sẽ chuyển về trạng thái "Chờ duyệt" và cần Admin phê duyệt lại.')) return;

            const token = auth.getToken('tochuc');

            try {
                const res = await fetch(`${CONFIG.API_URL}/organization/chien-dich/${campaignId}/mo-lai`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await res.json();
                if (data.success) {
                    alert(data.message);
                    loadCampaigns();
                } else {
                    alert(data.message || 'Có lỗi xảy ra');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Lỗi kết nối server');
            }
        }

        // Init
        loadCampaigns();
    </script>
</body>

</html>