<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o c√°o - T·ªï ch·ª©c</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../../assets/css/style.css">
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="flex">
        <!-- Sidebar -->
        <div id="tochuc-sidebar"></div>

        <!-- Main Content -->
        <main class="flex-1 ml-64 p-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">B√°o c√°o</h1>
                    <p class="text-gray-500">Qu·∫£n l√Ω b√°o c√°o chi·∫øn d·ªãch</p>
                </div>
                <button onclick="openCreateModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    T·∫°o b√°o c√°o
                </button>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-4">
                    <p class="text-sm text-gray-500">T·ªïng b√°o c√°o</p>
                    <p class="text-2xl font-bold text-blue-600" id="statTotal">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <p class="text-sm text-gray-500">Ti·∫øn ƒë·ªô</p>
                    <p class="text-2xl font-bold text-green-600" id="statProgress">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <p class="text-sm text-gray-500">T√†i ch√≠nh</p>
                    <p class="text-2xl font-bold text-yellow-600" id="statFinance">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <p class="text-sm text-gray-500">T·ªïng k·∫øt</p>
                    <p class="text-2xl font-bold text-purple-600" id="statSummary">0</p>
                </div>
            </div>

            <!-- Report List -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-4 border-b flex flex-wrap gap-3 justify-between items-center">
                    <h2 class="font-bold text-gray-800">Danh s√°ch b√°o c√°o</h2>
                    <div class="flex flex-wrap gap-2 items-center">
                        <input type="text" id="searchInput" onkeyup="renderReports()" placeholder="T√¨m ki·∫øm..." class="px-3 py-1 border rounded text-sm w-40">
                        <select id="filterCampaign" onchange="renderReports()" class="px-3 py-1 border rounded text-sm">
                            <option value="">T·∫•t c·∫£ chi·∫øn d·ªãch</option>
                        </select>
                        <select id="filterType" onchange="renderReports()" class="px-3 py-1 border rounded text-sm">
                            <option value="">T·∫•t c·∫£ lo·∫°i</option>
                            <option value="tien_do">Ti·∫øn ƒë·ªô</option>
                            <option value="tai_chinh">T√†i ch√≠nh</option>
                            <option value="tong_ket">T·ªïng k·∫øt</option>
                        </select>
                        <button onclick="exportToCSV()" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">Xu·∫•t Excel</button>
                    </div>
                </div>
                <div id="reportList" class="divide-y">
                    <div class="p-6 text-center text-gray-500">ƒêang t·∫£i...</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal T·∫°o b√°o c√°o -->
    <div id="createModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="font-bold text-gray-800">T·∫°o b√°o c√°o m·ªõi</h3>
                <button onclick="closeCreateModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form id="reportForm" class="p-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Chi·∫øn d·ªãch *</label>
                    <select id="campaignSelect" required class="w-full px-3 py-2 border rounded-lg">
                        <option value="">Ch·ªçn chi·∫øn d·ªãch</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Lo·∫°i b√°o c√°o *</label>
                    <select id="reportType" required onchange="toggleFinanceFields()" class="w-full px-3 py-2 border rounded-lg">
                        <option value="tien_do">B√°o c√°o ti·∫øn ƒë·ªô</option>
                        <option value="tai_chinh">B√°o c√°o t√†i ch√≠nh</option>
                        <option value="tong_ket">B√°o c√°o t·ªïng k·∫øt</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ti√™u ƒë·ªÅ *</label>
                    <input type="text" id="reportTitle" required class="w-full px-3 py-2 border rounded-lg" placeholder="VD: B√°o c√°o tu·∫ßn 1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">N·ªôi dung *</label>
                    <textarea id="reportContent" required rows="4" class="w-full px-3 py-2 border rounded-lg" placeholder="N·ªôi dung chi ti·∫øt b√°o c√°o..."></textarea>
                </div>
                <div id="financeFields" class="hidden grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">T·ªïng thu (VNƒê)</label>
                        <input type="number" id="totalIncome" class="w-full px-3 py-2 border rounded-lg" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">T·ªïng chi (VNƒê)</label>
                        <input type="number" id="totalExpense" class="w-full px-3 py-2 border rounded-lg" placeholder="0">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">H√¨nh ·∫£nh minh ch·ª©ng</label>
                    <input type="file" id="reportImage" accept="image/*" class="w-full px-3 py-2 border rounded-lg text-sm">
                    <p class="text-xs text-gray-400 mt-1">Ch·∫•p nh·∫≠n: JPG, PNG, GIF (t·ªëi ƒëa 5MB)</p>
                    <div id="imagePreview" class="mt-2 hidden">
                        <img id="previewImg" class="max-h-32 rounded border" alt="Preview">
                    </div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeCreateModal()" class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">H·ªßy</button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">T·∫°o b√°o c√°o</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Xem chi ti·∫øt -->
    <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center p-4 border-b sticky top-0 bg-white">
                <h3 class="font-bold text-gray-800">Chi ti·∫øt b√°o c√°o</h3>
                <button onclick="closeDetailModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="detailContent" class="p-4"></div>
        </div>
    </div>

    <!-- Modal S·ª≠a b√°o c√°o -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="font-bold text-gray-800">S·ª≠a b√°o c√°o</h3>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form id="editReportForm" class="p-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Chi·∫øn d·ªãch</label>
                    <select id="editCampaignSelect" disabled class="w-full px-3 py-2 border rounded-lg bg-gray-100">
                        <option value="">Ch·ªçn chi·∫øn d·ªãch</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-1">Kh√¥ng th·ªÉ thay ƒë·ªïi chi·∫øn d·ªãch</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Lo·∫°i b√°o c√°o *</label>
                    <select id="editReportType" required onchange="toggleEditFinanceFields()" class="w-full px-3 py-2 border rounded-lg">
                        <option value="tien_do">B√°o c√°o ti·∫øn ƒë·ªô</option>
                        <option value="tai_chinh">B√°o c√°o t√†i ch√≠nh</option>
                        <option value="tong_ket">B√°o c√°o t·ªïng k·∫øt</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ti√™u ƒë·ªÅ *</label>
                    <input type="text" id="editReportTitle" required class="w-full px-3 py-2 border rounded-lg" placeholder="VD: B√°o c√°o tu·∫ßn 1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">N·ªôi dung *</label>
                    <textarea id="editReportContent" required rows="4" class="w-full px-3 py-2 border rounded-lg" placeholder="N·ªôi dung chi ti·∫øt b√°o c√°o..."></textarea>
                </div>
                <div id="editFinanceFields" class="hidden grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">T·ªïng thu (VNƒê)</label>
                        <input type="number" id="editTotalIncome" class="w-full px-3 py-2 border rounded-lg" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">T·ªïng chi (VNƒê)</label>
                        <input type="number" id="editTotalExpense" class="w-full px-3 py-2 border rounded-lg" placeholder="0">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">H√¨nh ·∫£nh minh ch·ª©ng</label>
                    <input type="file" id="editReportImage" accept="image/*" class="w-full px-3 py-2 border rounded-lg text-sm">
                    <p class="text-xs text-gray-400 mt-1">ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën thay ƒë·ªïi ·∫£nh</p>
                    <div id="editImagePreview" class="mt-2 hidden">
                        <img id="editPreviewImg" class="max-h-32 rounded border" alt="Preview">
                    </div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeEditModal()" class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">H·ªßy</button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">L∆∞u thay ƒë·ªïi</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../../assets/js/config.js"></script>
    <script src="../../assets/js/tochuc-sidebar.js"></script>
    <script src="../../assets/js/unread-messages.js"></script>
    <script>
        if (!auth.isLoggedInAs('tochuc')) {
            window.location.href = '../login-tochuc.html';
        }

        let allReports = [];
        let allCampaigns = [];

        function logout() {
            auth.logoutAs('tochuc');
            window.location.href = '../login-tochuc.html';
        }

        function formatMoney(a) { return new Intl.NumberFormat('vi-VN').format(a || 0) + 'ƒë'; }
        function formatDate(d) { return d ? new Date(d).toLocaleDateString('vi-VN') : '-'; }

        function getTypeBadge(type) {
            const badges = {
                'tien_do': '<span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs">Ti·∫øn ƒë·ªô</span>',
                'tai_chinh': '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs">T√†i ch√≠nh</span>',
                'tong_ket': '<span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs">T·ªïng k·∫øt</span>'
            };
            return badges[type] || type;
        }

        async function loadData() {
            const token = auth.getToken('tochuc');
            try {
                // Load reports
                const resReports = await fetch(`${CONFIG.API_URL}/organization/bao-cao`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const dataReports = await resReports.json();
                if (dataReports.success) allReports = dataReports.data;

                // Load campaigns
                const resCampaigns = await fetch(`${CONFIG.API_URL}/organization/chien-dich`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const dataCampaigns = await resCampaigns.json();
                if (dataCampaigns.success) {
                    allCampaigns = dataCampaigns.data;
                    populateCampaignSelect();
                }

                updateStats();
                renderReports();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function populateCampaignSelect() {
            const options = '<option value="">Ch·ªçn chi·∫øn d·ªãch</option>' +
                allCampaigns.map(c => `<option value="${c.chien_dich_id}">${c.ten_chien_dich}</option>`).join('');
            document.getElementById('campaignSelect').innerHTML = options;
            document.getElementById('editCampaignSelect').innerHTML = options;
            
            // Filter dropdown
            const filterOptions = '<option value="">T·∫•t c·∫£ chi·∫øn d·ªãch</option>' +
                allCampaigns.map(c => `<option value="${c.chien_dich_id}">${c.ten_chien_dich}</option>`).join('');
            document.getElementById('filterCampaign').innerHTML = filterOptions;
        }

        function updateStats() {
            document.getElementById('statTotal').textContent = allReports.length;
            document.getElementById('statProgress').textContent = allReports.filter(r => r.loai_bao_cao === 'tien_do').length;
            document.getElementById('statFinance').textContent = allReports.filter(r => r.loai_bao_cao === 'tai_chinh').length;
            document.getElementById('statSummary').textContent = allReports.filter(r => r.loai_bao_cao === 'tong_ket').length;
        }

        function renderReports() {
            const filterType = document.getElementById('filterType').value;
            const filterCampaign = document.getElementById('filterCampaign').value;
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = allReports;
            
            if (filterType) {
                filtered = filtered.filter(r => r.loai_bao_cao === filterType);
            }
            if (filterCampaign) {
                filtered = filtered.filter(r => r.chien_dich_id == filterCampaign);
            }
            if (searchText) {
                filtered = filtered.filter(r => 
                    r.tieu_de.toLowerCase().includes(searchText) ||
                    (r.noi_dung && r.noi_dung.toLowerCase().includes(searchText)) ||
                    (r.ten_chien_dich && r.ten_chien_dich.toLowerCase().includes(searchText))
                );
            }

            if (filtered.length === 0) {
                document.getElementById('reportList').innerHTML = '<div class="p-6 text-center text-gray-500">Ch∆∞a c√≥ b√°o c√°o n√†o</div>';
                return;
            }

            document.getElementById('reportList').innerHTML = filtered.map(r => `
                <div class="p-4 hover:bg-gray-50">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-semibold text-gray-800">${r.tieu_de}</h3>
                                ${getTypeBadge(r.loai_bao_cao)}
                            </div>
                            <p class="text-sm text-blue-600 mb-1">${r.ten_chien_dich || 'Chi·∫øn d·ªãch'}</p>
                            <p class="text-sm text-gray-500 line-clamp-2">${r.noi_dung || ''}</p>
                            ${r.loai_bao_cao === 'tai_chinh' ? `
                                <div class="flex gap-4 mt-2 text-sm">
                                    <span class="text-green-600">Thu: ${formatMoney(r.tong_thu)}</span>
                                    <span class="text-red-600">Chi: ${formatMoney(r.tong_chi)}</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="text-right ml-4">
                            <p class="text-xs text-gray-400">${formatDate(r.ngay_bao_cao)}</p>
                            <button onclick="viewDetail(${r.bao_cao_id})" class="mt-2 text-blue-600 text-sm hover:underline">Xem chi ti·∫øt</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openCreateModal() {
            document.getElementById('createModal').classList.remove('hidden');
            document.getElementById('reportForm').reset();
            document.getElementById('imagePreview').classList.add('hidden');
            toggleFinanceFields();
        }

        function closeCreateModal() {
            document.getElementById('createModal').classList.add('hidden');
        }

        function toggleFinanceFields() {
            const type = document.getElementById('reportType').value;
            document.getElementById('financeFields').classList.toggle('hidden', type !== 'tai_chinh');
        }

        // Preview ·∫£nh khi ch·ªçn file
        document.getElementById('reportImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('imagePreview').classList.add('hidden');
            }
        });

        document.getElementById('editReportImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('editPreviewImg').src = e.target.result;
                    document.getElementById('editImagePreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('reportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const token = auth.getToken('tochuc');

            const formData = new FormData();
            formData.append('chien_dich_id', document.getElementById('campaignSelect').value);
            formData.append('loai_bao_cao', document.getElementById('reportType').value);
            formData.append('tieu_de', document.getElementById('reportTitle').value);
            formData.append('noi_dung', document.getElementById('reportContent').value);
            formData.append('tong_thu', document.getElementById('totalIncome').value || 0);
            formData.append('tong_chi', document.getElementById('totalExpense').value || 0);
            
            const imageFile = document.getElementById('reportImage').files[0];
            if (imageFile) {
                formData.append('hinh_anh', imageFile);
            }

            try {
                const res = await fetch(`${CONFIG.API_URL}/organization/bao-cao`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                const data = await res.json();
                if (data.success) {
                    alert('T·∫°o b√°o c√°o th√†nh c√¥ng!');
                    closeCreateModal();
                    loadData();
                } else {
                    alert(data.message || 'C√≥ l·ªói x·∫£y ra');
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi server');
            }
        });

        function viewDetail(id) {
            const r = allReports.find(r => r.bao_cao_id === id);
            if (!r) return;

            const imageUrl = r.file_dinh_kem ? `${CONFIG.API_URL.replace('/api', '')}${r.file_dinh_kem}` : null;

            document.getElementById('detailContent').innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <h2 class="text-xl font-bold text-gray-800">${r.tieu_de}</h2>
                            ${getTypeBadge(r.loai_bao_cao)}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openEditModal(${r.bao_cao_id})" class="px-3 py-1 text-blue-600 border border-blue-600 rounded hover:bg-blue-50 text-sm">S·ª≠a</button>
                            <button onclick="deleteReport(${r.bao_cao_id})" class="px-3 py-1 text-red-600 border border-red-600 rounded hover:bg-red-50 text-sm">X√≥a</button>
                        </div>
                    </div>
                    <div class="flex gap-4 text-sm text-gray-500">
                        <span>üìÖ ${formatDate(r.ngay_bao_cao)}</span>
                        <span>üìÅ ${r.ten_chien_dich || 'Chi·∫øn d·ªãch'}</span>
                    </div>
                    ${r.loai_bao_cao === 'tai_chinh' ? `
                        <div class="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                            <div>
                                <p class="text-sm text-gray-500">T·ªïng thu</p>
                                <p class="text-xl font-bold text-green-600">${formatMoney(r.tong_thu)}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">T·ªïng chi</p>
                                <p class="text-xl font-bold text-red-600">${formatMoney(r.tong_chi)}</p>
                            </div>
                        </div>
                    ` : ''}
                    <div>
                        <p class="text-sm font-medium text-gray-700 mb-2">N·ªôi dung b√°o c√°o</p>
                        <div class="p-4 bg-gray-50 rounded-lg whitespace-pre-wrap text-gray-700">${r.noi_dung || 'Kh√¥ng c√≥ n·ªôi dung'}</div>
                    </div>
                    ${imageUrl ? `
                        <div>
                            <p class="text-sm font-medium text-gray-700 mb-2">üì∑ H√¨nh ·∫£nh minh ch·ª©ng</p>
                            <img src="${imageUrl}" alt="H√¨nh ·∫£nh b√°o c√°o" class="max-w-full rounded-lg border cursor-pointer hover:opacity-90" onclick="window.open('${imageUrl}', '_blank')">
                        </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('detailModal').classList.remove('hidden');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        // M·ªü modal s·ª≠a b√°o c√°o
        let editingReportId = null;
        function openEditModal(id) {
            const r = allReports.find(r => r.bao_cao_id === id);
            if (!r) return;
            
            editingReportId = id;
            closeDetailModal();
            
            document.getElementById('editCampaignSelect').value = r.chien_dich_id;
            document.getElementById('editReportType').value = r.loai_bao_cao;
            document.getElementById('editReportTitle').value = r.tieu_de;
            document.getElementById('editReportContent').value = r.noi_dung || '';
            document.getElementById('editTotalIncome').value = r.tong_thu || 0;
            document.getElementById('editTotalExpense').value = r.tong_chi || 0;
            document.getElementById('editReportImage').value = '';
            
            // Hi·ªÉn th·ªã ·∫£nh hi·ªán t·∫°i n·∫øu c√≥
            if (r.file_dinh_kem) {
                const imageUrl = `${CONFIG.API_URL.replace('/api', '')}${r.file_dinh_kem}`;
                document.getElementById('editPreviewImg').src = imageUrl;
                document.getElementById('editImagePreview').classList.remove('hidden');
            } else {
                document.getElementById('editImagePreview').classList.add('hidden');
            }
            
            toggleEditFinanceFields();
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            editingReportId = null;
        }

        function toggleEditFinanceFields() {
            const type = document.getElementById('editReportType').value;
            document.getElementById('editFinanceFields').classList.toggle('hidden', type !== 'tai_chinh');
        }

        // Submit s·ª≠a b√°o c√°o
        document.getElementById('editReportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!editingReportId) return;
            
            const token = auth.getToken('tochuc');
            const formData = new FormData();
            formData.append('loai_bao_cao', document.getElementById('editReportType').value);
            formData.append('tieu_de', document.getElementById('editReportTitle').value);
            formData.append('noi_dung', document.getElementById('editReportContent').value);
            formData.append('tong_thu', document.getElementById('editTotalIncome').value || 0);
            formData.append('tong_chi', document.getElementById('editTotalExpense').value || 0);
            
            const imageFile = document.getElementById('editReportImage').files[0];
            if (imageFile) {
                formData.append('hinh_anh', imageFile);
            }

            try {
                const res = await fetch(`${CONFIG.API_URL}/organization/bao-cao/${editingReportId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                const data = await res.json();
                if (data.success) {
                    alert('C·∫≠p nh·∫≠t b√°o c√°o th√†nh c√¥ng!');
                    closeEditModal();
                    loadData();
                } else {
                    alert(data.message || 'C√≥ l·ªói x·∫£y ra');
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi server');
            }
        });

        // X√≥a b√°o c√°o
        async function deleteReport(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√°o c√°o n√†y?')) return;
            
            const token = auth.getToken('tochuc');
            try {
                const res = await fetch(`${CONFIG.API_URL}/organization/bao-cao/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.success) {
                    alert('X√≥a b√°o c√°o th√†nh c√¥ng!');
                    closeDetailModal();
                    loadData();
                } else {
                    alert(data.message || 'C√≥ l·ªói x·∫£y ra');
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi server');
            }
        }

        // Xu·∫•t b√°o c√°o ra CSV (Excel) - theo filter hi·ªán t·∫°i
        function exportToCSV() {
            // L·∫•y d·ªØ li·ªáu ƒë√£ filter
            const filterType = document.getElementById('filterType').value;
            const filterCampaign = document.getElementById('filterCampaign').value;
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            
            let dataToExport = allReports;
            
            if (filterType) {
                dataToExport = dataToExport.filter(r => r.loai_bao_cao === filterType);
            }
            if (filterCampaign) {
                dataToExport = dataToExport.filter(r => r.chien_dich_id == filterCampaign);
            }
            if (searchText) {
                dataToExport = dataToExport.filter(r => 
                    r.tieu_de.toLowerCase().includes(searchText) ||
                    (r.noi_dung && r.noi_dung.toLowerCase().includes(searchText)) ||
                    (r.ten_chien_dich && r.ten_chien_dich.toLowerCase().includes(searchText))
                );
            }
            
            if (dataToExport.length === 0) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t');
                return;
            }
            
            const typeLabels = { 'tien_do': 'Ti·∫øn ƒë·ªô', 'tai_chinh': 'T√†i ch√≠nh', 'tong_ket': 'T·ªïng k·∫øt' };
            
            // L·∫•y t√™n chi·∫øn d·ªãch n·∫øu ƒëang filter
            let fileName = 'bao-cao';
            if (filterCampaign) {
                const campaign = allCampaigns.find(c => c.chien_dich_id == filterCampaign);
                if (campaign) {
                    fileName = `bao-cao-${campaign.ten_chien_dich.replace(/[^a-zA-Z0-9\u00C0-\u1EF9]/g, '-')}`;
                }
            }
            
            // Header
            let csv = '\uFEFF'; // BOM for UTF-8
            csv += 'STT,Ti√™u ƒë·ªÅ,Lo·∫°i b√°o c√°o,Chi·∫øn d·ªãch,N·ªôi dung,T·ªïng thu,T·ªïng chi,Ng√†y t·∫°o\n';
            
            // Data
            dataToExport.forEach((r, i) => {
                const row = [
                    i + 1,
                    `"${(r.tieu_de || '').replace(/"/g, '""')}"`,
                    typeLabels[r.loai_bao_cao] || r.loai_bao_cao,
                    `"${(r.ten_chien_dich || '').replace(/"/g, '""')}"`,
                    `"${(r.noi_dung || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`,
                    r.tong_thu || 0,
                    r.tong_chi || 0,
                    formatDate(r.ngay_bao_cao)
                ];
                csv += row.join(',') + '\n';
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${fileName}-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Init
        loadData();
    </script>
</body>
</html>
