<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang ch·ªß - Thi·ªán Nguy·ªán</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        .like-btn.liked { color: #e74c3c; }
        .like-btn.liked svg { fill: #e74c3c; }
        .comment-input:focus { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-2 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="home.html" class="flex items-center gap-2">
                    <div class="w-10 h-10 gradient-heart rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </a>
                <div class="relative hidden sm:block">
                    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm chi·∫øn d·ªãch..."
                        class="w-64 pl-10 pr-4 py-2 bg-gray-100 rounded-full outline-none focus:bg-white focus:ring-2 focus:ring-blue-500">
                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>

            <nav class="hidden md:flex items-center gap-2">
                <a href="home.html" class="p-3 rounded-lg bg-blue-50 text-blue-600" title="Trang ch·ªß">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                    </svg>
                </a>
                <a href="chien-dich.html" class="p-3 rounded-lg text-gray-500 hover:bg-gray-100" title="Chi·∫øn d·ªãch">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                </a>
                <a href="to-chuc.html" class="p-3 rounded-lg text-gray-500 hover:bg-gray-100" title="T·ªï ch·ª©c">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                </a>
            </nav>

            <div class="flex items-center gap-3">
                <button class="p-2 bg-gray-100 rounded-full hover:bg-gray-200 relative">
                    <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" />
                    </svg>
                </button>
                <div class="relative" id="userMenu">
                    <button onclick="toggleUserMenu()" class="flex items-center gap-2 p-1 rounded-full hover:bg-gray-100">
                        <div class="w-9 h-9 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold" id="userAvatar">U</div>
                    </button>
                    <div id="userDropdown" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-lg border py-2">
                        <div class="px-4 py-3 border-b">
                            <p class="font-semibold text-gray-800" id="userName">Ng∆∞·ªùi d√πng</p>
                            <p class="text-sm text-gray-500" id="userEmail">user@email.com</p>
                        </div>
                        <a href="profile.html" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-100">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            <span>Trang c√° nh√¢n</span>
                        </a>
                        <a href="hoat-dong.html" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-100">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            <span>Ho·∫°t ƒë·ªông c·ªßa t√¥i</span>
                        </a>
                        <hr class="my-2">
                        <button onclick="logout()" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-100 w-full text-left text-red-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                            <span>ƒêƒÉng xu·∫•t</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>


    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 py-6">
        <div class="flex gap-6">
            <!-- Left Sidebar -->
            <aside class="hidden lg:block w-64 flex-shrink-0">
                <nav class="space-y-1 sticky top-20">
                    <a href="profile.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-white">
                        <div class="w-9 h-9 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold" id="sidebarAvatar">U</div>
                        <span class="font-medium text-gray-800" id="sidebarName">Ng∆∞·ªùi d√πng</span>
                    </a>
                    <a href="chien-dich.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-white">
                        <div class="w-9 h-9 bg-green-100 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <span class="text-gray-700">Chi·∫øn d·ªãch</span>
                    </a>
                    <a href="to-chuc.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-white">
                        <div class="w-9 h-9 bg-purple-100 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5" />
                            </svg>
                        </div>
                        <span class="text-gray-700">T·ªï ch·ª©c</span>
                    </a>
                    <a href="hoat-dong.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-white">
                        <div class="w-9 h-9 bg-blue-100 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                        </div>
                        <span class="text-gray-700">Ho·∫°t ƒë·ªông c·ªßa t√¥i</span>
                    </a>
                </nav>
            </aside>

            <!-- Main Feed -->
            <div class="flex-1 max-w-xl">
                <!-- Newsfeed -->
                <div id="newsfeed" class="space-y-4">
                    <div class="bg-white rounded-lg shadow p-6 text-center text-gray-500">
                        ƒêang t·∫£i b√†i vi·∫øt...
                    </div>
                </div>

                <!-- Load More -->
                <div id="loadMoreContainer" class="text-center mt-6 hidden">
                    <button onclick="loadMore()" class="px-6 py-2 bg-white rounded-lg shadow hover:bg-gray-50 text-gray-600">
                        Xem th√™m
                    </button>
                </div>
            </div>

            <!-- Right Sidebar -->
            <aside class="hidden xl:block w-72 flex-shrink-0">
                <div class="sticky top-20 space-y-4">
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">Chi·∫øn d·ªãch n·ªïi b·∫≠t</h3>
                        <div id="featuredCampaigns" class="space-y-3">
                            <p class="text-sm text-gray-500">ƒêang t·∫£i...</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">T·ªï ch·ª©c uy t√≠n</h3>
                        <div id="topOrgs" class="space-y-3">
                            <p class="text-sm text-gray-500">ƒêang t·∫£i...</p>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </main>


    <!-- Modal Quy√™n g√≥p -->
    <div id="donateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Quy√™n g√≥p</h3>
                <button onclick="closeDonateModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <p id="donateModalTitle" class="text-gray-600 mb-4"></p>
            <form id="donateForm">
                <input type="hidden" id="donateCampaignId">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">S·ªë ti·ªÅn (VNƒê)</label>
                    <input type="number" id="donateAmount" min="10000" step="10000" required
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    <div class="flex gap-2 mt-2">
                        <button type="button" onclick="setAmount(50000)" class="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200 text-sm">50K</button>
                        <button type="button" onclick="setAmount(100000)" class="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200 text-sm">100K</button>
                        <button type="button" onclick="setAmount(200000)" class="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200 text-sm">200K</button>
                        <button type="button" onclick="setAmount(500000)" class="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200 text-sm">500K</button>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="donateAnonymous" class="rounded">
                        <span class="text-sm text-gray-700">Quy√™n g√≥p ·∫©n danh</span>
                    </label>
                </div>
                <button type="submit" class="w-full gradient-primary text-white py-3 rounded-lg font-semibold btn-hover">X√°c nh·∫≠n</button>
            </form>
        </div>
    </div>

    <!-- Modal Share -->
    <div id="shareModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Chia s·∫ª chi·∫øn d·ªãch</h3>
                <button onclick="closeShareModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <p id="shareModalTitle" class="text-gray-600 mb-4"></p>
            <form id="shareForm">
                <input type="hidden" id="shareCampaignId">
                <div class="mb-4">
                    <textarea id="shareContent" rows="3" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Vi·∫øt g√¨ ƒë√≥ v·ªÅ chi·∫øn d·ªãch n√†y..."></textarea>
                </div>
                <div class="flex gap-3 mb-4">
                    <button type="button" onclick="copyLink()" class="flex-1 py-2 border rounded-lg hover:bg-gray-50 text-sm">üìã Sao ch√©p link</button>
                </div>
                <button type="submit" class="w-full gradient-primary text-white py-3 rounded-lg font-semibold btn-hover">Chia s·∫ª</button>
            </form>
        </div>
    </div>

    <script src="../assets/js/config.js"></script>
    <script>
        let currentPage = 1;
        let isLoading = false;
        let hasMore = true;
        const likedPosts = new Set();

        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p user
        if (!auth.isLoggedInAs('user')) {
            window.location.href = 'login.html';
        }

        // User info - l·∫•y theo lo·∫°i user
        const user = auth.getUser('user');
        if (user) {
            const initial = user.ho_ten ? user.ho_ten.charAt(0).toUpperCase() : 'U';
            document.getElementById('userAvatar').textContent = initial;
            document.getElementById('sidebarAvatar').textContent = initial;
            document.getElementById('userName').textContent = user.ho_ten || 'Ng∆∞·ªùi d√πng';
            document.getElementById('sidebarName').textContent = user.ho_ten || 'Ng∆∞·ªùi d√πng';
            document.getElementById('userEmail').textContent = user.email || '';
        }

        function toggleUserMenu() { document.getElementById('userDropdown').classList.toggle('hidden'); }
        document.addEventListener('click', e => {
            if (!document.getElementById('userMenu').contains(e.target)) {
                document.getElementById('userDropdown').classList.add('hidden');
            }
        });
        function logout() { auth.logoutAs('user'); window.location.href = 'login.html'; } // Ch·ªâ logout user
        function formatMoney(a) { return new Intl.NumberFormat('vi-VN').format(a) + 'ƒë'; }
        function formatDate(d) { return new Date(d).toLocaleDateString('vi-VN'); }
        function timeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            if (seconds < 60) return 'V·ª´a xong';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' ph√∫t tr∆∞·ªõc';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' gi·ªù tr∆∞·ªõc';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' ng√†y tr∆∞·ªõc';
            return formatDate(date);
        }


        // Render m·ªôt b√†i post
        function renderPost(c) {
            const progress = c.muc_tieu_tien > 0 ? (c.so_tien_da_quyen_gop / c.muc_tieu_tien * 100).toFixed(1) : 0;
            const defaultImg = 'https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?w=600';
            const isLiked = likedPosts.has(c.chien_dich_id);

            return `
                <article class="bg-white rounded-lg shadow" data-id="${c.chien_dich_id}">
                    <!-- Header -->
                    <div class="p-4 flex items-center gap-3">
                        <a href="to-chuc-detail.html?id=${c.to_chuc_id}" class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">
                            ${c.ten_to_chuc?.charAt(0) || 'T'}
                        </a>
                        <div class="flex-1">
                            <a href="to-chuc-detail.html?id=${c.to_chuc_id}" class="font-semibold text-gray-800 hover:underline">${c.ten_to_chuc}</a>
                            <p class="text-xs text-gray-500">${timeAgo(c.ngay_tao)} ¬∑ üìç ${c.dia_diem || 'Vi·ªát Nam'}</p>
                        </div>
                        <a href="chien-dich-detail.html?id=${c.chien_dich_id}" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                        </a>
                    </div>

                    <!-- Content -->
                    <div class="px-4 pb-3">
                        <h3 class="font-bold text-lg text-gray-800 mb-2">${c.ten_chien_dich}</h3>
                        <p class="text-gray-600 text-sm mb-3 line-clamp-3">${c.mo_ta || ''}</p>
                    </div>

                    <!-- Image -->
                    <a href="chien-dich-detail.html?id=${c.chien_dich_id}">
                        <img src="${c.hinh_anh_url || defaultImg}" alt="${c.ten_chien_dich}" 
                            class="w-full h-64 object-cover" onerror="this.src='${defaultImg}'">
                    </a>

                    <!-- Progress -->
                    <div class="px-4 py-3 border-t">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-600">ƒê√£ quy√™n g√≥p</span>
                            <span class="font-semibold text-green-600">${formatMoney(c.so_tien_da_quyen_gop)} / ${formatMoney(c.muc_tieu_tien)}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                            <div class="bg-gradient-to-r from-green-400 to-green-600 h-2 rounded-full transition-all" style="width: ${Math.min(progress, 100)}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>${progress}% ƒë·∫°t ƒë∆∞·ª£c</span>
                            <span>üìÖ C√≤n ${getDaysLeft(c.ngay_ket_thuc)} ng√†y</span>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="px-4 py-2 border-t flex justify-between text-sm text-gray-500">
                        <span id="likeCount-${c.chien_dich_id}">${c.like_count || 0} l∆∞·ª£t th√≠ch</span>
                        <div class="flex gap-4">
                            <span id="commentCount-${c.chien_dich_id}">${c.comment_count || 0} b√¨nh lu·∫≠n</span>
                            <span>${c.share_count || 0} chia s·∫ª</span>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="px-4 py-2 border-t flex">
                        <button onclick="toggleLike(${c.chien_dich_id})" class="like-btn flex-1 flex items-center justify-center gap-2 py-2 rounded-lg hover:bg-gray-100 transition ${isLiked ? 'liked text-red-500' : 'text-gray-600'}" id="likeBtn-${c.chien_dich_id}">
                            <svg class="w-5 h-5" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                            </svg>
                            <span>Th√≠ch</span>
                        </button>
                        <button onclick="toggleComments(${c.chien_dich_id})" class="flex-1 flex items-center justify-center gap-2 py-2 rounded-lg hover:bg-gray-100 text-gray-600 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                            </svg>
                            <span>B√¨nh lu·∫≠n</span>
                        </button>
                        <button onclick="openShareModal(${c.chien_dich_id}, '${c.ten_chien_dich.replace(/'/g, "\\'")}')" class="flex-1 flex items-center justify-center gap-2 py-2 rounded-lg hover:bg-gray-100 text-gray-600 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                            </svg>
                            <span>Chia s·∫ª</span>
                        </button>
                    </div>

                    <!-- Comments Section (hidden by default) -->
                    <div id="comments-${c.chien_dich_id}" class="hidden border-t">
                        <div class="p-4">
                            <div class="flex gap-3 mb-4">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-semibold flex-shrink-0">
                                    ${user?.ho_ten?.charAt(0).toUpperCase() || 'U'}
                                </div>
                                <div class="flex-1 flex gap-2">
                                    <input type="text" id="commentInput-${c.chien_dich_id}" placeholder="Vi·∫øt b√¨nh lu·∫≠n..." 
                                        class="comment-input flex-1 px-4 py-2 bg-gray-100 rounded-full outline-none text-sm"
                                        onkeypress="if(event.key==='Enter') submitComment(${c.chien_dich_id})">
                                    <button onclick="submitComment(${c.chien_dich_id})" class="px-4 py-2 bg-blue-500 text-white rounded-full text-sm hover:bg-blue-600">G·ª≠i</button>
                                </div>
                            </div>
                            <div id="commentList-${c.chien_dich_id}" class="space-y-3"></div>
                        </div>
                    </div>

                    <!-- Quick Donate -->
                    <div class="px-4 py-3 border-t bg-gray-50 rounded-b-lg">
                        <button onclick="openDonateModal(${c.chien_dich_id}, '${c.ten_chien_dich.replace(/'/g, "\\'")}')" 
                            class="w-full gradient-primary text-white py-2 rounded-lg font-medium btn-hover flex items-center justify-center gap-2">
                            ‚ù§Ô∏è Quy√™n g√≥p ngay
                        </button>
                    </div>
                </article>
            `;
        }

        function getDaysLeft(endDate) {
            const days = Math.ceil((new Date(endDate) - new Date()) / (1000 * 60 * 60 * 24));
            return days > 0 ? days : 0;
        }


        // Load newsfeed
        async function loadNewsfeed(page = 1, append = false) {
            if (isLoading) return;
            isLoading = true;

            try {
                const res = await fetch(`${CONFIG.API_URL}/chien-dich?page=${page}&limit=5&trang_thai=dang_dien_ra`);
                const data = await res.json();

                if (!data.success) throw new Error('Failed to load');

                const feed = document.getElementById('newsfeed');
                
                if (data.data.length === 0 && page === 1) {
                    feed.innerHTML = '<div class="bg-white rounded-lg shadow p-6 text-center text-gray-500">Ch∆∞a c√≥ chi·∫øn d·ªãch n√†o</div>';
                    return;
                }

                const html = data.data.map(c => renderPost(c)).join('');
                
                if (append) {
                    feed.insertAdjacentHTML('beforeend', html);
                } else {
                    feed.innerHTML = html;
                }

                hasMore = data.pagination.page < data.pagination.totalPages;
                document.getElementById('loadMoreContainer').classList.toggle('hidden', !hasMore);
                currentPage = page;

                // Check liked status for logged in user
                if (auth.isLoggedInAs('user')) {
                    data.data.forEach(c => checkLikeStatus(c.chien_dich_id));
                }
            } catch (error) {
                console.error('Error:', error);
            } finally {
                isLoading = false;
            }
        }

        function loadMore() {
            if (hasMore) loadNewsfeed(currentPage + 1, true);
        }

        // Like functions
        async function checkLikeStatus(id) {
            try {
                const token = auth.getToken('user');
                if (!token) return;
                
                const res = await fetch(`${CONFIG.API_URL}/social/${id}/like/check`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (data.success && data.liked) {
                    likedPosts.add(id);
                    updateLikeUI(id, true);
                }
            } catch (e) {}
        }

        async function toggleLike(id) {
            if (!auth.isLoggedInAs('user')) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th√≠ch');
                return;
            }

            const token = auth.getToken('user');
            try {
                const res = await fetch(`${CONFIG.API_URL}/social/${id}/like`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (data.success) {
                    if (data.liked) {
                        likedPosts.add(id);
                    } else {
                        likedPosts.delete(id);
                    }
                    updateLikeUI(id, data.liked);
                    updateLikeCount(id);
                }
            } catch (e) {
                console.error('Like error:', e);
            }
        }

        function updateLikeUI(id, liked) {
            const btn = document.getElementById(`likeBtn-${id}`);
            if (!btn) return;
            
            if (liked) {
                btn.classList.add('liked', 'text-red-500');
                btn.querySelector('svg').setAttribute('fill', 'currentColor');
            } else {
                btn.classList.remove('liked', 'text-red-500');
                btn.querySelector('svg').setAttribute('fill', 'none');
            }
        }

        async function updateLikeCount(id) {
            try {
                const res = await fetch(`${CONFIG.API_URL}/social/${id}/like/count`);
                const data = await res.json();
                if (data.success) {
                    document.getElementById(`likeCount-${id}`).textContent = `${data.count} l∆∞·ª£t th√≠ch`;
                }
            } catch (e) {}
        }

        // Comment functions
        function toggleComments(id) {
            const section = document.getElementById(`comments-${id}`);
            const isHidden = section.classList.contains('hidden');
            
            section.classList.toggle('hidden');
            
            if (isHidden) {
                loadComments(id);
                document.getElementById(`commentInput-${id}`).focus();
            }
        }

        async function loadComments(id) {
            const list = document.getElementById(`commentList-${id}`);
            list.innerHTML = '<p class="text-sm text-gray-500">ƒêang t·∫£i...</p>';

            try {
                const res = await fetch(`${CONFIG.API_URL}/social/${id}/comments`);
                const data = await res.json();

                if (!data.success || data.data.length === 0) {
                    list.innerHTML = '<p class="text-sm text-gray-500 text-center">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o</p>';
                    return;
                }

                list.innerHTML = data.data.map(c => `
                    <div class="flex gap-3">
                        <div class="w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center text-white text-sm font-semibold flex-shrink-0">
                            ${c.ho_ten?.charAt(0).toUpperCase() || 'U'}
                        </div>
                        <div class="flex-1">
                            <div class="bg-gray-100 rounded-2xl px-4 py-2">
                                <p class="font-semibold text-sm text-gray-800">${c.ho_ten || 'Ng∆∞·ªùi d√πng'}</p>
                                <p class="text-sm text-gray-700">${c.noi_dung}</p>
                            </div>
                            <p class="text-xs text-gray-500 mt-1 ml-2">${timeAgo(c.ngay_binh_luan)}</p>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                list.innerHTML = '<p class="text-sm text-red-500">L·ªói t·∫£i b√¨nh lu·∫≠n</p>';
            }
        }

        async function submitComment(id) {
            if (!auth.isLoggedInAs('user')) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n');
                return;
            }

            const input = document.getElementById(`commentInput-${id}`);
            const content = input.value.trim();
            if (!content) return;

            const token = auth.getToken('user');
            try {
                const res = await fetch(`${CONFIG.API_URL}/social/${id}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ noi_dung: content })
                });
                const data = await res.json();

                if (data.success) {
                    input.value = '';
                    loadComments(id);
                    // Update comment count
                    const countEl = document.getElementById(`commentCount-${id}`);
                    const current = parseInt(countEl.textContent) || 0;
                    countEl.textContent = `${current + 1} b√¨nh lu·∫≠n`;
                } else {
                    alert(data.message);
                }
            } catch (e) {
                alert('L·ªói g·ª≠i b√¨nh lu·∫≠n');
            }
        }


        // Share functions
        function openShareModal(id, title) {
            if (!auth.isLoggedInAs('user')) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ chia s·∫ª');
                return;
            }
            document.getElementById('shareCampaignId').value = id;
            document.getElementById('shareModalTitle').textContent = title;
            document.getElementById('shareModal').classList.remove('hidden');
        }

        function closeShareModal() {
            document.getElementById('shareModal').classList.add('hidden');
            document.getElementById('shareForm').reset();
        }

        function copyLink() {
            const id = document.getElementById('shareCampaignId').value;
            const url = `${window.location.origin}/frontend/pages/chien-dich-detail.html?id=${id}`;
            navigator.clipboard.writeText(url).then(() => {
                alert('ƒê√£ sao ch√©p link!');
            });
        }

        document.getElementById('shareForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('shareCampaignId').value;
            const token = auth.getToken('user');

            try {
                const res = await fetch(`${CONFIG.API_URL}/social/${id}/share`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        noi_dung: document.getElementById('shareContent').value
                    })
                });
                const data = await res.json();
                if (data.success) {
                    alert('Chia s·∫ª th√†nh c√¥ng!');
                    closeShareModal();
                }
            } catch (e) {
                alert('L·ªói chia s·∫ª');
            }
        });

        // Donate functions
        function openDonateModal(id, title) {
            if (!auth.isLoggedInAs('user')) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ quy√™n g√≥p');
                window.location.href = 'login.html';
                return;
            }
            document.getElementById('donateCampaignId').value = id;
            document.getElementById('donateModalTitle').textContent = title;
            document.getElementById('donateModal').classList.remove('hidden');
        }

        function closeDonateModal() {
            document.getElementById('donateModal').classList.add('hidden');
            document.getElementById('donateForm').reset();
        }

        function setAmount(a) {
            document.getElementById('donateAmount').value = a;
        }

        document.getElementById('donateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('donateCampaignId').value;
            const token = auth.getToken('user');

            try {
                const res = await fetch(`${CONFIG.API_URL}/chien-dich/${id}/donate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        so_tien: parseInt(document.getElementById('donateAmount').value),
                        an_danh: document.getElementById('donateAnonymous').checked
                    })
                });
                const data = await res.json();
                if (data.success) {
                    alert('Quy√™n g√≥p th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ‚ù§Ô∏è');
                    closeDonateModal();
                    loadNewsfeed();
                } else {
                    alert(data.message);
                }
            } catch (e) {
                alert('L·ªói quy√™n g√≥p');
            }
        });

        // Load featured campaigns
        async function loadFeatured() {
            try {
                const res = await fetch(`${CONFIG.API_URL}/chien-dich?limit=3&sort=most_funded&trang_thai=dang_dien_ra`);
                const data = await res.json();
                
                if (data.success && data.data.length > 0) {
                    document.getElementById('featuredCampaigns').innerHTML = data.data.map(c => `
                        <a href="chien-dich-detail.html?id=${c.chien_dich_id}" class="flex gap-3 p-2 rounded-lg hover:bg-gray-50">
                            <img src="${c.hinh_anh_url || 'https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?w=100'}" 
                                class="w-12 h-12 rounded object-cover" onerror="this.src='https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?w=100'">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-800 truncate">${c.ten_chien_dich}</p>
                                <p class="text-xs text-green-600">${formatMoney(c.so_tien_da_quyen_gop)}</p>
                            </div>
                        </a>
                    `).join('');
                }
            } catch (e) {}
        }

        // Load top organizations
        async function loadTopOrgs() {
            try {
                const res = await fetch(`${CONFIG.API_URL}/tochuc?limit=3`);
                const data = await res.json();
                
                if (data.success && data.data.length > 0) {
                    document.getElementById('topOrgs').innerHTML = data.data.map(o => `
                        <a href="to-chuc-detail.html?id=${o.to_chuc_id}" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white font-bold">
                                ${o.ten_to_chuc.charAt(0)}
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-800 truncate">${o.ten_to_chuc}</p>
                                <p class="text-xs text-gray-500">${o.so_chien_dich_dang_chay || 0} chi·∫øn d·ªãch</p>
                            </div>
                        </a>
                    `).join('');
                }
            } catch (e) {}
        }

        // Search
        let searchTimeout;
        document.getElementById('searchInput')?.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (this.value.trim()) {
                    window.location.href = `chien-dich.html?search=${encodeURIComponent(this.value)}`;
                }
            }, 800);
        });

        // Init
        loadNewsfeed();
        loadFeatured();
        loadTopOrgs();
    </script>
</body>
</html>
